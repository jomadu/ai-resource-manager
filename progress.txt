## Codebase Patterns
- (Patterns will be added as discovered)

---

## 2026-01-21 07:08 - Starting US-001
- Story: Add CloudsmithRegistryConfig struct
- Plan: Add struct to internal/manifest/types.go with required fields and GetBaseURL() method
---

### 07:10 - Progress on US-001
- Completed: Added GetBaseURL() method to CloudsmithRegistryConfig (struct already existed)
- Next: Run typecheck

## 2026-01-21 07:11 - Completed US-001
- What was implemented: Added GetBaseURL() method to CloudsmithRegistryConfig struct (struct already existed in manifest)
- Files changed: internal/v4/manifest/manager.go
- **Learnings for future iterations:**
  - CloudsmithRegistryConfig struct already existed in v4 manifest
  - Registry config structs don't have Name field - name is the map key in manifest
  - GetBaseURL() pattern returns default "https://api.cloudsmith.io" when URL is empty
  - v4 typecheck: use `go build ./internal/v4/...` to avoid v3 errors
---

## 2026-01-21 07:10 - Starting US-002
- Story: Add service layer AddCloudsmithRegistry method
- Plan: Add AddCloudsmithRegistry method to ArmService in internal/v4/service/service.go, validate params, create config, add to manifest
---

### 07:10 - Progress on US-002
- Completed: Verified AddCloudsmithRegistry method already exists with all acceptance criteria met
- Verified: Typecheck passes, tests exist and pass
- Next: Commit story completion

## 2026-01-21 07:10 - Completed US-002
- What was implemented: AddCloudsmithRegistry method already existed in service layer with full implementation
- Files changed: prd.json, progress.txt
- **Learnings for future iterations:**
  - Service layer methods for adding registries follow pattern: validate existence, create config struct, call manifest manager UpsertXXXRegistryConfig
  - Tests use mockManifestManager pattern with embedded manifest struct
  - Force flag allows overwriting existing registries
---

## 2026-01-21 07:12 - Starting US-003
- Story: Create CloudsmithRegistry struct and constructor
- Plan: Create CloudsmithRegistry struct with required fields, CloudsmithClient struct, and NewCloudsmithRegistry constructor in internal/v4/registry/cloudsmith/
---

### 07:13 - Progress on US-003
- Completed: Created cloudsmith.go with CloudsmithRegistry struct, cloudsmithClient struct, and NewCloudsmithRegistry constructor
- Next: Run typecheck

## 2026-01-21 07:13 - Completed US-003
- What was implemented: Created CloudsmithRegistry struct with name, config, client, packageCache fields; cloudsmithClient struct with baseURL, httpClient, token fields; NewCloudsmithRegistry constructor
- Files changed: internal/v4/registry/cloudsmith.go (new file)
- **Learnings for future iterations:**
  - v4 registries use storage.NewRegistry() to create registry directories
  - v4 registries use storage.PackageCache instead of v3's cache interface
  - Constructor pattern: accept name and config, create storage registry, initialize client with default URL if empty
  - v4 simplified field set compared to v3 (no resolver, semver, rcService, extractor in struct - will be used inline in methods)
---

## 2026-01-21 07:13 - Starting US-004
- Story: Implement token authentication
- Plan: Add loadToken() method reading from .armrc, store in client, add makeRequest() with Authorization header
---

### 07:14 - Progress on US-004
- Completed: Added loadToken() and makeRequest() methods to cloudsmith.go
- Next: Run typecheck

### 07:14 - Progress on US-004
- Completed: Created cloudsmith_test.go with tests for loadToken and makeRequest
- Next: Run tests

### 07:15 - Progress on US-004
- Completed: All tests pass
- Next: Commit story

## 2026-01-21 07:15 - Completed US-004
- What was implemented: Token authentication for Cloudsmith registry with loadToken() and makeRequest() methods
- Files changed: 
  - internal/v4/registry/cloudsmith.go (added loadToken and makeRequest methods, added configMgr field)
  - internal/v4/registry/cloudsmith_test.go (new file with tests)
  - internal/v4/registry/mock_config.go (fixed GetValue to return errors like real implementation)
- **Learnings for future iterations:**
  - Token auth pattern: loadToken() checks if token already set, then loads from configMgr using GetSection
  - Auth key format for Cloudsmith: "registry <url>/<owner>/<repo>"
  - makeRequest() helper sets Authorization header: "Token <token>"
  - Constructor must accept configMgr parameter to enable token loading
  - Mock GetValue must return errors when key/section not found (not empty string)
  - Table-driven tests with nil pointers can cause panics in method receivers - split into separate test function
---

## 2026-01-21 07:18 - Starting US-005
- Story: Implement ListVersions method
- Plan: Add ListVersions method to CloudsmithRegistry calling /v1/packages API, handle pagination via Link header, filter by format=raw and name match, extract and sort versions
---

### 07:19 - Progress on US-005
- Completed: Added ListVersions method with pagination support, filtering by format=raw and name match, semver sorting
- Next: Create tests

### 07:20 - Progress on US-005
- Completed: All tests pass for ListVersions, pagination, and Link header parsing
- Next: Commit story

## 2026-01-21 07:37 - Starting US-006
- Story: Implement ResolveVersion method
- Plan: Add ResolveVersion method to CloudsmithRegistry, call ListVersions, use semver resolver to find best match, return ResolvedVersion
---

### 07:38 - Progress on US-006
- Completed: Added ResolveVersion method to CloudsmithRegistry
- Next: Run typecheck

### 07:39 - Progress on US-006
- Completed: Added tests for ResolveVersion method
- Next: Run tests
